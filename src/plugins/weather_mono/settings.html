<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
    .section-border-grid {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .section-border-option {
        text-align: center;
        border: 2px solid transparent;
        padding: 5px;
        cursor: pointer;
        border-radius: 5px;
        transition: border-color 0.3s ease;
    }

    .section-border-option img {
        width: auto;
        height: auto;
        max-width: 100px;
        filter: var(--image-filter);
        transition: filter 0.3s ease;
    }

    .section-border-option.selected {
        border-color: #007bff;
    }
</style>

<div class="form-group">
    <label class="form-label">Location: </label>
    <div class="form-group">
        <span>Latitude </span>
        <input readonly type="text" id="latitude" name="latitude" class="form-input" />
    </div>
    <div class="form-group">
        <span>Longitude </span>
        <input readonly type="text" id="longitude" name="longitude" class="form-input" />
    </div>
    <button type="button" id="openMap" class="action-button compact">Select Location</button>
</div>

<div class="form-group">
    <label for="weatherProvider" class="form-label">Weather Provider:</label>
    <select id="weatherProvider" name="weatherProvider" class="form-input" onchange="updateTitleOptions(this.value)">
        <option value="OpenMeteo">Open-Meteo</option>
        <option value="OpenWeatherMap">OpenWeatherMap</option>
    </select>

    <label for="units" class="form-label">Units:</label>
    <select id="units" name="units" class="form-input">
        <option value="imperial">Imperial (°F)</option>
        <option value="metric">Metric (°C)</option>
        <option value="standard">Standard (K)</option>
    </select>
</div>

<div class="form-group" id="titleOptionWrapper">
    <label class="form-label">Title:</label>

    <div class="form-group">
        <input type="radio" id="title-location" name="titleSelection" value="location">
        <label for="title-location">Location</label>

        <input type="radio" id="title-custom" name="titleSelection" value="custom">
        <label for="title-custom">Custom</label>
        <input type="text" id="customTitle" name="customTitle" class="form-input" placeholder="Type something..." />
    </div>
</div>

<div class="form-group">
    <label for="displayMetrics" class="form-label">Display: </label>

    <div class="form-group">
      <input type="checkbox" id="displayRefreshTime" name="displayRefreshTime" onclick="this.value=this.checked ? 'true' : 'false';">
      <span>Refresh Time</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayMetrics" name="displayMetrics" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Metrics</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayGraph" name="displayGraph" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Weather Graph</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayRain" name="displayRain" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Rain Amount</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="moonPhase" name="moonPhase" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Moon Phase</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayForecast" name="displayForecast" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Forecast</span>
        <select id="forecastDays" name="forecastDays" class="form-input">
            <option value=3>3</option>
            <option value=5>5</option>
            <option value=7>7</option>
        </select>
        <span>days</span>
    </div>

    <div class="form-group">
        <label for="weatherTimeZone" class="form-label">Time Zone:</label>
        <select id="weatherTimeZone" name="weatherTimeZone" class="form-input">
            <option value="locationTimeZone">Use Location Time Zone</option>
            <option value="localTimeZone">Use Local Time Zone</option>
        </select>
    </div>

    <div class="separator"></div>
    <div class="collapsible" style="width: 100%;">
        <button type="button" class="collapsible-header" onclick="toggleCollapsible(this)">
            Style Options <span class="collapsible-icon">▼</span>
        </button>
        <div class="settings-container collapsible-content">
            <div class="form-group" style="width: 100%; flex-basis: 100%;">
                <label class="form-label" style="width: 100%;">Text Sizes:</label>
            </div>

            <div class="form-group">
                <label for="headerTextScale" class="form-label">Header Text Size:</label>
                <select id="headerTextScale" name="headerTextScale" class="form-input">
                    <option value="80">80%</option>
                    <option value="90">90%</option>
                    <option value="100">100%</option>
                    <option value="110">110%</option>
                    <option value="120">120%</option>
                    <option value="130">130%</option>
                    <option value="140">140%</option>
                    <option value="150">150%</option>
                </select>
            </div>

            <div class="form-group">
                <label for="mainTextScale" class="form-label">Main Temp Text Size:</label>
                <select id="mainTextScale" name="mainTextScale" class="form-input">
                    <option value="80">80%</option>
                    <option value="90">90%</option>
                    <option value="100">100%</option>
                    <option value="110">110%</option>
                    <option value="120">120%</option>
                    <option value="130">130%</option>
                    <option value="140">140%</option>
                    <option value="150">150%</option>
                </select>
            </div>

            <div class="form-group">
                <label for="detailTextScale" class="form-label">Metrics/Forecast Text Size:</label>
                <select id="detailTextScale" name="detailTextScale" class="form-input">
                    <option value="80">80%</option>
                    <option value="90">90%</option>
                    <option value="100">100%</option>
                    <option value="110">110%</option>
                    <option value="120">120%</option>
                    <option value="130">130%</option>
                    <option value="140">140%</option>
                    <option value="150">150%</option>
                </select>
            </div>

            <div class="form-group" style="width: 100%; flex-basis: 100%;">
                <label class="form-label" style="width: 100%;">Alignments</label>
            </div>

            <div class="form-group">
                <label for="headerAlignment" class="form-label">Header Alignment:</label>
                <select id="headerAlignment" name="headerAlignment" class="form-input">
                    <option value="left">Left</option>
                    <option value="center">Center</option>
                    <option value="right">Right</option>
                </select>
            </div>

            <div class="form-group" style="width: 100%; flex-basis: 100%;">
                <label class="form-label" style="width: 100%;">Border Style</label>
            </div>

            <div class="form-group">
                <label for="sectionBorderStyle" class="form-label">Section Border Style:</label>
                <div id="section-border-style-selection" class="section-border-grid">
                    <div class="section-border-option" data-border-style="none" onclick="selectedSectionBorderStyle(this)">
                        <img src="{{ url_for('plugin.image', plugin_id='base_plugin', filename='frames/blank.png') }}" alt="None" />
                    </div>
                    <div class="section-border-option" data-border-style="corner" onclick="selectedSectionBorderStyle(this)">
                        <img src="{{ url_for('plugin.image', plugin_id='base_plugin', filename='frames/corner.png') }}" alt="Corner" />
                    </div>
                    <div class="section-border-option" data-border-style="top-bottom" onclick="selectedSectionBorderStyle(this)">
                        <img src="{{ url_for('plugin.image', plugin_id='base_plugin', filename='frames/top_and_bottom.png') }}" alt="Top and Bottom" />
                    </div>
                    <div class="section-border-option" data-border-style="rectangle" onclick="selectedSectionBorderStyle(this)">
                        <img src="{{ url_for('plugin.image', plugin_id='base_plugin', filename='frames/rectangle.png') }}" alt="Rectangle" />
                    </div>
                </div>
                <input type="hidden" id="sectionBorderStyle" name="sectionBorderStyle" value="rectangle" />
            </div>
        </div>
    </div>

</div>

<div id="mapModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('mapModal')">×</span>
        <h2 id="modalTitle">Select Location</h2>
        <div class="separator"></div>
        <div id="map" style="width: 100%; height: 200px; margin: 10px 0px;"></div>
        <button id="closeMap" class="action-button">Save</button>
    </div>
</div>

<script>

    function selectedSectionBorderStyle(element) {
        if (!element) return;

        const previousSelection = document.querySelector('.section-border-option.selected');
        if (previousSelection) {
            previousSelection.classList.remove('selected');
        }

        element.classList.add('selected');
        document.getElementById('sectionBorderStyle').value = element.getAttribute('data-border-style');
    }

    function updateTitleOptions(provider) {
        const titleLocationRadio = document.getElementById('title-location');
        const titleLocationLabel = document.querySelector('label[for="title-location"]');
        const titleCustomRadio = document.getElementById('title-custom');
        const customTitleInput = document.getElementById('customTitle');
        const titleTimeZone = document.getElementById('weatherTimeZone');
        const titleTimeZoneLabel = document.querySelector('label[for="weatherTimeZone"]');
        const apiKeyLabel = document.querySelector('.api-key-label');

        if (provider === 'OpenMeteo') {
            // Hide or disable "Location" radio option
            titleLocationRadio.style.display = 'none';
            titleLocationLabel.style.display = 'none';
            titleLocationRadio.disabled = true;
            titleTimeZone.style.display = 'none';
            titleTimeZoneLabel.style.display = 'none';
            titleTimeZone.disabled = true;

            // Select and enable "Custom"
            titleCustomRadio.checked = true;
            titleCustomRadio.disabled = false;
            customTitleInput.disabled = false;

            // Hide API Key required label for Open-Meteo
            if (apiKeyLabel) apiKeyLabel.style.display = 'none';
        } else {
            // Show and enable both options
            titleLocationRadio.style.display = '';
            titleLocationLabel.style.display = '';
            titleLocationRadio.disabled = false;

            titleCustomRadio.disabled = false;
            customTitleInput.disabled = false;

            titleTimeZone.style.display = '';
            titleTimeZoneLabel.style.display = '';
            titleTimeZone.disabled = false;

            // Show API Key required label for OpenWeatherMap
            if (apiKeyLabel) apiKeyLabel.style.display = '';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {

        const OSM_TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        const $latitude = document.querySelector('#latitude');
        const $longitude = document.querySelector('#longitude');
        const $openMap = document.querySelector('#openMap');
        const $mapModal = document.querySelector('#mapModal');
        const $closeMap = document.querySelector('#closeMap');

        let latitude = +$latitude.value;
        let longitude = +$longitude.value;
        let zoom = latitude && longitude ? 4.5 : 2.5;
        let selectedTitle = 'location';
        let weatherProvider = 'OpenMeteo';

        let map, marker;

        $openMap.addEventListener('click', () => {
            openModal('mapModal')
            setTimeout(() => {
                if (!map) {
                    map = L.map('map').setView([latitude, longitude], zoom);
                    L.tileLayer(OSM_TILE_URL).addTo(map);
                    marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);

                    map.on('click', event => {
                        marker.setLatLng(event.latlng);
                    });
                }
            }, 100);
        });

        $closeMap.addEventListener('click', () => {
            const position = marker.getLatLng().wrap();
            $latitude.value = position.lat;
            $longitude.value = position.lng;
            closeModal('mapModal');
        });

        if (loadPluginSettings) {
            document.getElementById('latitude').value = pluginSettings.latitude;
            document.getElementById('longitude').value = pluginSettings.longitude;

            document.getElementById('units').value = pluginSettings.units;

            document.getElementById('headerTextScale').value = ['80','90','100','110','120','130','140','150'].includes(String(pluginSettings.headerTextScale)) ? String(pluginSettings.headerTextScale) : '100';
            document.getElementById('mainTextScale').value = ['80','90','100','110','120','130','140','150'].includes(String(pluginSettings.mainTextScale)) ? String(pluginSettings.mainTextScale) : '100';
            document.getElementById('detailTextScale').value = ['80','90','100','110','120','130','140','150'].includes(String(pluginSettings.detailTextScale)) ? String(pluginSettings.detailTextScale) : '100';
            document.getElementById('headerAlignment').value = ['left','center','right'].includes(String(pluginSettings.headerAlignment)) ? String(pluginSettings.headerAlignment) : 'center';
            const sectionBorderStyle = ['none','corner','top-bottom','rectangle'].includes(String(pluginSettings.sectionBorderStyle)) ? String(pluginSettings.sectionBorderStyle) : 'rectangle';
            const sectionBorderStyleOption = document.querySelector(`.section-border-option[data-border-style="${sectionBorderStyle}"]`);
            selectedSectionBorderStyle(sectionBorderStyleOption);

            document.getElementById('displayRefreshTime').checked = pluginSettings.displayRefreshTime;
            document.getElementById('displayRefreshTime').value = pluginSettings.displayRefreshTime;

            document.getElementById('displayMetrics').checked = pluginSettings.displayMetrics;
            document.getElementById('displayMetrics').value = pluginSettings.displayMetrics;

            document.getElementById('displayGraph').checked = pluginSettings.displayGraph;
            document.getElementById('displayGraph').value = pluginSettings.displayGraph;

			document.getElementById('displayRain').checked = pluginSettings.displayRain;
            document.getElementById('displayRain').value = pluginSettings.displayRain;

            document.getElementById('displayForecast').checked = pluginSettings.displayForecast;
            document.getElementById('displayForecast').value = pluginSettings.displayForecast;

            document.getElementById('forecastDays').value = pluginSettings.forecastDays;

            document.getElementById('moonPhase').checked = pluginSettings.moonPhase;
            document.getElementById('moonPhase').value = pluginSettings.moonPhase;

            document.getElementById('weatherTimeZone').value = pluginSettings.weatherTimeZone;

            selectedTitle = pluginSettings.titleSelection || 'location';
            weatherProvider = pluginSettings.weatherProvider || 'OpenMeteo';

            document.getElementById('customTitle').value = pluginSettings.customTitle || '';
        } else {
            // set default values
            document.getElementById('units').value = "imperial";
            document.getElementById('headerTextScale').value = "100";
            document.getElementById('mainTextScale').value = "100";
            document.getElementById('detailTextScale').value = "100";
            document.getElementById('headerAlignment').value = "center";
            const sectionBorderStyleOption = document.querySelector('.section-border-option[data-border-style="rectangle"]');
            selectedSectionBorderStyle(sectionBorderStyleOption);
            document.getElementById('displayRefreshTime').checked = true;
            document.getElementById('displayRefreshTime').value = "true";
            document.getElementById('displayMetrics').checked = true;
            document.getElementById('displayMetrics').value = "true";
            document.getElementById('displayGraph').checked = true;
            document.getElementById('displayGraph').value = "true";
			document.getElementById('displayRain').checked = false;
            document.getElementById('displayRain').value = "false";
            document.getElementById('displayForecast').checked = true;
            document.getElementById('displayForecast').value = "true";
            document.getElementById('forecastDays').value = 7;
            document.getElementById('moonPhase').checked = false;
            document.getElementById('weatherTimeZone').value = "locationTimeZone";
        }

        document.getElementById('weatherProvider').value = weatherProvider;
        document.querySelector(`input[name="titleSelection"][value="${selectedTitle}"]`).checked = true;
        updateTitleOptions(weatherProvider)
    });
</script>
